var b=Object.defineProperty,j=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var V=(t,e,n)=>e in t?b(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,y=(t,e)=>{for(var n in e||(e={}))Q.call(e,n)&&V(t,n,e[n]);if(M)for(var n of M(e))z.call(e,n)&&V(t,n,e[n]);return t},I=(t,e)=>j(t,q(e));var u=(t,e,n)=>new Promise((l,T)=>{var P=S=>{try{h(n.next(S))}catch(A){T(A)}},U=S=>{try{h(n.throw(S))}catch(A){T(A)}},h=S=>S.done?l(S.value):Promise.resolve(S.value).then(P,U);h((n=n.apply(t,e)).next())});import{u as W,aD as X,aU as m,b4 as p,cM as D,cN as k,R as w,aS as $,J as R,aT as J,a5 as Y,cO as Z,$ as tt,cC as N,E as et,b0 as L,b1 as B}from"./index-9e787fa5.js";import{u as at,a as ot,P as C,f as E,C as _,g as nt}from"./chartEditStore-56d3c83a.js";import{f as rt,d as st,e as it,c as dt}from"./index-f6f97c94.js";import{u as ct,C as G}from"./chartLayoutStore-58ece452.js";import{b as lt,u as x,s as ft,f as St}from"./project-c1868b8d.js";const pt=t=>t,Ct=(t,e)=>{try{if(e.id){const n="vnodeBeforeMount"in e.events,l="vnodeMounted"in e.events;return n&&(t.events.advancedEvents.vnodeBeforeMount=e==null?void 0:e.events.vnodeBeforeMount),l&&(t.events.advancedEvents.vnodeMounted=e==null?void 0:e.events.vnodeMounted),(n||l)&&(e.events={baseEvent:{[L.ON_CLICK]:void 0,[L.ON_DBL_CLICK]:void 0,[L.ON_MOUSE_ENTER]:void 0,[L.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[B.VNODE_MOUNTED]:void 0,[B.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch(n){return t}},g=(t,e,n=!1)=>{if(Ct(t,e),n)return N(t,e);const l=e.option;if(!l)return N(t,e);if(e.option=void 0,l)return I(y({},N(t,e)),{option:l})},yt=()=>{const t=at(),e=ot(),n=W(),l=ct(),T=(o,c=!1,i=!1)=>u(void 0,null,function*(){c&&(t.componentList=[],e.clearBackStack(),e.clearForwardStack()),o.editCanvasConfig=pt(o.editCanvasConfig),o.componentList.forEach(a=>u(void 0,null,function*(){const s=r=>{window.$vue.component(r.chartConfig.chartKey)||(window.$vue.component(r.chartConfig.chartKey,rt(r.chartConfig)),window.$vue.component(r.chartConfig.conKey,st(r.chartConfig)))};a.isGroup?a.groupList.forEach(r=>{s(r)}):s(a)}));const d=(a,s)=>u(void 0,null,function*(){let r=yield it(a.chartConfig);a.chartConfig.redirectComponent&&(a.chartConfig.dataset&&(r.option.dataset=a.chartConfig.dataset),r.chartConfig.title=a.chartConfig.title,r.chartConfig.chartFrame=a.chartConfig.chartFrame),s?s(i?g(r,I(y({},a),{id:R()})):g(r,a)):i?t.addComponentList(g(r,I(y({},a),{id:R()})),!1,!0):t.addComponentList(g(r,a),!1,!0)});for(const a in o)if(a===_.COMPONENT_LIST){let s=0;const r=o[a].length;for(const f of o[a]){let O=parseInt((parseFloat(`${++s/r}`)*100).toString());if(l.setItemUnHandle(G.PERCENTAGE,O),f.isGroup){let v=new nt;i?v=g(v,I(y({},f),{id:R()})):v=g(v,f);const F=[];for(const H of f.groupList)yield d(H,K=>{F.push(K)});v.groupList=F,t.addComponentList(v,!1,!0)}else yield d(f);O===100&&(e.clearBackStack(),e.clearForwardStack())}}else(a===_.EDIT_CANVAS_CONFIG||a===_.REQUEST_GLOBAL_CONFIG)&&g(t[a],o[a],!0);l.setItemUnHandle(G.PERCENTAGE,0)}),P=o=>{let c=dt(),d=et().getTemplateTypeInfo(o.typeId);c.loadPackagesList(o.templateType,d)},U=o=>{const{id:c,templateName:i,remarks:d,indexImage:a,state:s}=o;t.setProjectInfo(C.PROJECT_ID,c),t.setProjectInfo(C.PROJECT_NAME,i),t.setProjectInfo(C.REMARKS,d),t.setProjectInfo(C.THUMBNAIL,a),t.setProjectInfo(C.RELEASE,s===1)},h=()=>u(void 0,null,function*(){t.componentList=[],t.setEditCanvas(E.SAVE_STATUS,p.START);try{const o=yield St({templateId:m()});if(o&&o.code===w.SUCCESS){if(o.data){P(o.data),U(o.data),Object.keys(J(o.data.content)).length&&(yield T(J(o.data.content)));return}else t.setProjectInfo(C.PROJECT_ID,m());setTimeout(()=>{t.setEditCanvas(E.SAVE_STATUS,p.SUCCESS)},1e3);return}t.setEditCanvas(E.SAVE_STATUS,p.FAILURE)}catch(o){t.setEditCanvas(E.SAVE_STATUS,p.FAILURE),Y()}}),S=X((o=!0)=>u(void 0,null,function*(){if(!m())return;let c=t.getProjectInfo[C.PROJECT_ID];if(c===null||c===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(E.SAVE_STATUS,p.START);try{if(o){const a=document.querySelector(".go-edit-range"),s=yield D(a,{backgroundColor:null,allowTaint:!0,useCORS:!0});let r=new FormData;r.append("file",k(s.toDataURL(),`${m()}_index_preview.png`));const f=yield lt(r);f&&f.code===w.SUCCESS&&(f.data.fileurl?yield x({id:m(),indexImage:`${f.data.fileurl}`}):yield x({id:m(),indexImage:`${n.getFetchInfo.OSSUrl}${f.data.fileName}`}))}}catch(a){console.log(a)}let i=new FormData;i.append("templateId",c),i.append("content",$(t.getStorageInfo()||{}));const d=yield ft(i);if(d&&d.code===w.SUCCESS){setTimeout(()=>{t.setEditCanvas(E.SAVE_STATUS,p.SUCCESS)},1e3);return}t.setEditCanvas(E.SAVE_STATUS,p.FAILURE)}),3e3);return{updateComponent:T,updateStoreInfo:U,dataSyncFetch:h,dataSyncUpdate:S,dataSyncDownloadJson:()=>u(void 0,null,function*(){let o=t.getProjectInfo[C.PROJECT_ID];if(o===null||o===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(E.SAVE_STATUS,p.START);let c=$(t.getStorageInfo()||{});try{const d=document.querySelector(".go-edit-range"),a=yield D(d,{backgroundColor:null,allowTaint:!0,useCORS:!0});let s=yield k(a.toDataURL(),`${m()}_index_preview.png`);new FormData().append("object",s),console.log(s,"缩略图")}catch(d){console.log(d)}let i=new FormData;i.append("projectId",o),i.append("content",c),console.log(c,"画布数据")}),intervalDataSyncUpdate:()=>{const o=setInterval(()=>{S()},Z*1e3);tt(()=>{clearInterval(o)})}}};export{yt as u};
